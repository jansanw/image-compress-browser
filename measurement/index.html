<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>浏览器图片压缩测试</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
    button {
        margin: 10px;
    }
    div {
        margin: 10px;
    }

    img {
        max-width: 100%;
    }
    </style>
    <script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>

    <script src="/measurement/compressImage-full.js"></script>
</head>
<body>
    <h3>第一步：选择文件</h3>
    <input type="file" id="file" />

    <h3>第二步：选择压缩方式</h3>
    <button  class="way btn btn-default" data-type='compressOrientDataurl' >压缩，自定义获取方位，输出DataUrl</button>
    <button  class="way btn btn-success" data-type='compressOrientBlob' >压缩，自定义获取方位，输出Blob</button>
    <button  class="way btn btn-primary" data-type='compressExifDataurl' >压缩，Exif获取方位，输出DataUrl</button>
    <button  class="way btn btn-info" data-type='compressExifBlob' >压缩，Exif获取方位，输出Blob</button>
    <button  class="way btn btn-warning" data-type='compressNo' >不压缩</button>

    <h5>或者对以上5种方式循环自动压测10次</h5>
    <button id="totest" class="btn" >压测</button>


    <h4>过程和结果：</h4>
    <div id="click" class="bg-info" ></div>
    <div id="status" class="bg-primary" ></div>
    <div id="other" class="bg-success" ></div>

    <h4>图片展示：</h4>
    <div id="before" >
        原始：<img src="" alt="">
    </div>
    <div id="after" >
        最新：<img src="" alt="">
    </div>

    <h3>第三步：查看每一次测试的详细数据</h3>
    <a  class="btn btn-success" href='/report'>查看每一次测试的详细数据</a>

    <script>
    function compressAndUploadImg(file, callback) {
        statData.name = file.name;
        statData.total = performance.now();
        compressImage(file, function (base64OrFile, width, height) {
            statData.upload = performance.now();

            console.log('base64OrFile', base64OrFile);

            var formData = new FormData();
            formData.append('tn', 'wise');
            formData.append('image', base64OrFile);

            var params = {
                url: 'http://graph.baidu.com/upload',
                type: 'POST',
                timeout: 10000, // 10s
                data: formData,
                processData: false,
                contentType: false,
                cache: false,
                success: function (res) {
                    statData.upload = performance.now() - statData.upload;
                    statData.total = performance.now() - statData.total;

                    statData.url = '';
                    if (!res.status) {
                        statData.url = res.data.url;
                    }

                    if (typeof base64OrFile == 'string') {

                        $('#after img').attr('src', 'data:image/jpeg;base64,' + base64OrFile);
                    }
                    else {
                        var URL = window.URL || window.webkitURL;
                        var url = URL.createObjectURL(base64OrFile);
                        $('#after img').attr('src', url);
                    }

                    callback(res);
                },
                error: function (xhr, errorType) {
                    statData.upload = performance.now() - statData.upload;
                    statData.total = performance.now() - statData.total;

                    if (typeof base64OrFile == 'string') {

                        $('#after img').attr('src', 'data:image/jpeg;base64,' + base64OrFile);
                    }
                    else {
                        var URL = window.URL || window.webkitURL;
                        var url = URL.createObjectURL(base64OrFile);
                        $('#after img').attr('src', url);
                    }

                    callback({
                        status: 1,
                        info: 'ajaxerror,' + errorType
                    });


                }
            };

            $.ajax(params);
        });
    }

    $('#file').on('change', function () {
        var file = $('#file')[0].files[0];
        var URL = window.URL || window.webkitURL;
        var url = URL.createObjectURL(file);
        $('#before img').attr('src', url);
    });

    function start(type,cb) {
        cb = cb || function () {};
        window.statData = {
            os: navigator.userAgent.indexOf('iPhone OS') > -1 ? 'ios': 'android',
            phone: '浏览器', //'红米note, xiaoMi浏览器',
            upload: 0,
            fileTo: 0,
            toImg: 0,
            orient: 0,
            toCanvas: 0,
            rotate: 0,
            canvasOut: 0,
            total: 0
        };

        statData.type = type;
        var file = $('#file')[0].files[0];
        if (!file) {
            return alert('选择文件');
        }

        console.log('file', file);

        $('#click').html('文件信息：'+file.type + '  size: ' + file.size + '<br/>当前选择压缩方式：' + $(this).text());
        $('#status').html('上传中...');
        var t = Date.now();
        compressAndUploadImg(file,function (res) {
            $('#status').html(
                '返回状态：' + (!res.status ? '上传成功' : '上传失败') + '<br/> 耗时: ' + (Date.now()-t)
                + '<br/> 返回结果页:' + JSON.stringify(res)
            );

            // 发送统计日志
            var querys = [];
            for (var key in statData) {
                var val = statData[key] || '';
                if (val.toString().indexOf('.') > -1) {
                    try {
                        val = val.toFixed(2);
                    }
                    catch(e) {

                    }
                }
                querys.push(key + '=' + val);
            }
            (new Image()).src = '/log?' + querys.join('&');

            setTimeout(function () {
                cb();
            }, 200);
        });

        return false;
    }

    $('button.way').on('click', function () {
        start($(this).data('type'));
    });


    /**********
        压测
    */
    //
    var count = 10;
    var buttons = $('button.way');
    var total = buttons.length * count;
    var wayNum = buttons.length;

    function digui(cur) {
        if (cur > total) {
            $('#totest').text('压测:' + wayNum + '* ' + count +'次，已完成');
            return;
        }

        var wayI = (cur - 1) % wayNum;
        var type = buttons.eq(wayI).data('type');
        $('#totest').text('压测:' + wayNum + '* ' + count +'次，当前：第' + (cur) +'次，类型: ' + type);
        start(type, function () {
            cur++;
            digui(cur);
        });
    }

    $('#totest').on('click', function () {
        var file = $('#file')[0].files[0];
        if (!file) {
            return alert('选择文件');
        }
        digui(1);
    });

    // 全局错误监听
    window.addEventListener('error', function (e) {
        var error = e.error || {};
        var obj = {
            message: e.message,
            line: e.lineno || e.line,
            column: e.colno || e.column,
            stack: error.stack,
            sourceURL: e.filename || e.sourceURL
        };
        (new Image()).src = '/error?info=' + JSON.stringify(obj);
    });

    </script>
</body>
</html>
