!function(t,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a():"function"==typeof define&&define.amd?define(a):t.compressImage=a()}(this,function(){"use strict";function t(){!function(t){var a=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,e=t.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),n=e&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),r=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,o=(e||r)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(t){var a,o,i,s,f,c,l,u,m;if(!(a=t.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/)))throw new Error("invalid data URI");for(o=a[2]?a[1]:"text/plain"+(a[3]||";charset=US-ASCII"),i=!!a[4],s=t.slice(a[0].length),f=i?atob(s):decodeURIComponent(s),c=new ArrayBuffer(f.length),l=new Uint8Array(c),u=0;u<f.length;u+=1)l[u]=f.charCodeAt(u);return e?new Blob([n?l:c],{type:o}):(m=new r,m.append(c),m.getBlob(o))};t.HTMLCanvasElement&&!a.toBlob&&(a.mozGetAsFile?a.toBlob=function(t,e,n){t(n&&a.toDataURL&&o?o(this.toDataURL(e,n)):this.mozGetAsFile("blob",e))}:a.toDataURL&&o&&(a.toBlob=function(t,a,e){t(o(this.toDataURL(a,e)))})),"function"==typeof define&&define.amd?define(function(){return o}):"object"==typeof module&&module.exports?module.exports=o:t.dataURLtoBlob=o}(window)}function a(t,a,e){for(var n="",r=a;r<a+e;r++)n+=String.fromCharCode(t.getUint8(r));return n}function e(t,e){if("Exif"!=a(t,e,4))return!1;var n=e+6,r=!1;if(18761==t.getUint16(n))r=!1;else{if(19789!=t.getUint16(n))return!1;r=!0}if(42!=t.getUint16(n+2,!r))return!1;var o=t.getUint32(n+4,!r);if(o<8)return!1;var i,s=n+o,f=t.getUint16(s,!r);console.log("entryNum",f);for(var c=0;c<f;c++){i=s+2+12*c,console.log("entry"+c,t.getUint8(i,!r).toString(16).toUpperCase(),t.getUint8(i+1,!r).toString(16).toUpperCase());if(274==t.getUint16(i,!r)){var l=t.getUint16(i+2,!r),u=t.getUint32(i+4,!r);t.getUint32(i+8,!r);if(3===l&&1===u)return console.log("Orientation",t.getUint16(i+8,!r)),t.getUint16(i+8,!r)}}return!1}function n(t){var a=new DataView(t);if(255!=a.getUint8(0)||216!=a.getUint8(1))return!1;for(var n=2,r=t.byteLength;n<r;){if(255!=a.getUint8(n))return!1;if(225==a.getUint8(n+1))return e(a,n+4);n+=2+a.getUint16(n+2)}return!1}function r(t,a){var e=new FileReader;e.onload=function(t){if(statData.type.indexOf("Orient")>-1){statData.orient=performance.now();var e=n(t.target.result);statData.orient=performance.now()-statData.orient,$("#other").html("get Orientation by 自己计算： "+e),a(e)}else{statData.orient=performance.now();var r=exif.readFromBinaryFile(t.target.result);statData.orient=performance.now()-statData.orient,$("#other").html("get Orientation by exif "+r.Orientation),a(r.Orientation)}},e.readAsArrayBuffer(t)}function o(t,a){if(statData.fileTo=performance.now(),statData.type.indexOf("Blob")>-1){var e=window.URL||window.webkitURL,n=e.createObjectURL(t);statData.fileTo=performance.now()-statData.fileTo,statData.toImg=performance.now();var r=new Image;r.onload=function(){statData.toImg=performance.now()-statData.toImg,a(r)},r.src=n}else{var o=new FileReader;o.onload=function(){statData.fileTo=performance.now()-statData.fileTo,statData.toImg=performance.now();var t=this.result,e=new Image;e.onload=function(){statData.toImg=performance.now()-statData.toImg,a(e)},e.onerror=function(){a()},e.src=t},o.onerror=function(t){a()},o.readAsDataURL(t)}}function i(a,e,n){t();var r=a.naturalWidth||a.width,o=a.naturalHeight||a.height;e&&"5678".indexOf(e)>-1&&(r=a.naturalHeight||a.height,o=a.naturalWidth||a.width),statData.oriWidth=r,statData.oriHeight=o;var i=r*o/1e6;i>1?(i=Math.sqrt(i),r/=i,o/=i):i=1,statData.newWidth=r,statData.newHeight=o;var s=document.createElement("canvas");s.width=r,s.height=o;var f=s.getContext("2d");switch(f.clearRect(0,0,r,o),f.save(),statData.rotate=performance.now(),e){case 3:f.rotate(180*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,-r,-o,r,o);break;case 6:f.rotate(90*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,0,-r,o,r);break;case 8:f.rotate(270*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,-o,0,o,r);break;case 2:f.translate(r,0),f.scale(-1,1),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,0,0,r,o);break;case 4:f.translate(r,0),f.scale(-1,1),f.rotate(180*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,-r,-o,r,o);break;case 5:f.translate(r,0),f.scale(-1,1),f.rotate(90*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,0,-r,o,r);break;case 7:f.translate(r,0),f.scale(-1,1),f.rotate(270*Math.PI/180),statData.rotate=performance.now()-statData.rotate,f.drawImage(a,-o,0,o,r);break;default:statData.rotate=performance.now()-statData.rotate,f.drawImage(a,0,0,r,o)}if(f.restore(),statData.toCanvas=performance.now()-statData.toCanvas,statData.canvasOut=performance.now(),statData.type.indexOf("Blob")>-1)s.toBlob(function(t){statData.canvasOut=performance.now()-statData.canvasOut,n(t,r,o)},"image/jpeg",.75);else{var c=s.toDataURL("image/jpeg",.75);statData.canvasOut=performance.now()-statData.canvasOut,n(c,r,o)}}function s(t,a){var e=t||{},n=a||function(){};return"image/jpeg"!==e.type?n(t):statData.type.indexOf("compressNo")>-1?n(t):void o(e,function(a){statData.oriSize=e.size,a?r(e,function(r){statData.orientation=r,r=r||1,r?(statData.toCanvas=performance.now(),i(a,r,function(t,r,o){if(statData.type.indexOf("Blob")>-1){var i=e.size<=t.size,s=t;i&&(s=e),statData.newSize=s.size,n(s)}else{var f=t,i=a.src.size<=f.size;i&&(f=a.src),statData.newSize=f.length;var c=f.split("base64,")[1];n(c,r,o,i)}})):n(t)}):n(t)})}return s});
